version: '3.8'

x-base-service: &base_service
  volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/timezone:/etc/timezone:ro
  networks:
    - recommended

x-spark-worker: &base_spark_worker
  image: docker.io/bitnami/spark:3.0.1
  restart: on-failure
  volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/timezone:/etc/timezone:ro
    - ./spark/.data:/opt/bitnami/spark/work/
  depends_on:
    spark-master:
      condition: service_healthy
  environment:
    - SPARK_MODE=worker
    - SPARK_MASTER_URL=spark://spark-master:${SPARK_MASTER_PORT}
    - SPARK_WORKER_MEMORY=2G
    - SPARK_WORKER_CORES=1
    - SPARK_RPC_AUTHENTICATION_ENABLED=no
    - SPARK_RPC_ENCRYPTION_ENABLED=no
    - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
    - SPARK_SSL_ENABLED=no

services:
  nginx:
    <<: *base_service
    image: nginx:1.23.1-alpine
    container_name: nginx
    profiles:
      - dev_recom
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/configs/:/etc/nginx/conf.d/:ro
      - ./nginx/static/errors:/var/www/errors/:ro
      - ./nginx/static/log/access_log:/var/log/nginx/access.log:rw
      - ./nginx/static/log/error_log:/var/log/nginx/error.log:rw
    ports:
      - ${SPARK_MASTER_WEB_PORT}:${SPARK_MASTER_WEB_PORT}

  spark-master:
    <<: *base_service
    image: docker.io/bitnami/spark:3.0.1
    container_name: spark-master
    hostname: spark-master
    restart: on-failure
    volumes:
      - ./spark/clickhouse-native-jdbc-shaded-2.6.4.jar:/opt/clickhouse-native-jdbc-shaded-2.6.4.jar
    profiles:
      - dev_recom
      - prod
    expose:
      - ${SPARK_MASTER_WEB_PORT}
      - ${SPARK_MASTER_PORT}
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    healthcheck:
      test: curl http://spark-master:${SPARK_MASTER_WEB_PORT} >/dev/null; if [[ $$? == 52 ]]; then echo 0; else echo 1; fi
      interval: 30s
      timeout: 10s
      retries: 5

  spark-worker01:
    <<: *base_service
    <<: *base_spark_worker
    container_name: spark-worker01
    hostname: spark-worker01
    profiles:
      - dev_recom
      - prod

  spark-worker02:
    <<: *base_service
    <<: *base_spark_worker
    container_name: spark-worker02
    hostname: spark-worker02
    profiles:
      - dev_recom
      - prod

  spark-worker03:
    <<: *base_service
    <<: *base_spark_worker
    container_name: spark-worker03
    hostname: spark-worker03
    profiles:
      - dev_recom
      - prod

  jupyter-notebook:
    <<: *base_service
    build: ./jupyter-notebook/
    container_name: jupyter-notebook
    hostname: jupyter-notebook
    depends_on:
      spark-master:
        condition: service_healthy
    volumes:
      - ./jupyter-notebook/clickhouse-native-jdbc-shaded-2.6.4.jar:/opt/clickhouse-native-jdbc-shaded-2.6.4.jar
      - ./jupyter-notebook/work:/home/developer/work
    profiles:
      - dev_recom
    ports:
      - ${NOTEBOOK_PORT}:${NOTEBOOK_PORT}


networks:
  recommended:
    driver: bridge
